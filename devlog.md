# 📘 수강신청 강좌 수집 도구 개발 로그

서울대학교 수강신청 사이트에서  
**강좌 목록 + 교과목 개요(국문/영문)**를 대량으로 안정적으로 수집하여  
CSV(엑셀) 파일로 저장하기까지의 설계 과정과 문제 해결 기록이다.

본 도구는 **엑셀 저장 차단을 우회하거나 변조하지 않으며**,  
사이트가 실제로 사용자에게 제공하는 정보와  
동일 출처 요청만을 사용해 데이터를 정리한다.

---

## 0. 출발점: 엑셀 저장 차단 문제

서울대 수강신청 사이트의 공식 **엑셀 저장** 기능은  
다음 학기(예: 2026학년도) 강좌에 대해 의도적으로 차단되어 있다.

내부 로직에는 다음과 같은 조건이 존재한다.

- 현재 학기보다 이후 학기일 경우
  - “다음 학기의 강좌는 엑셀저장이 불가능합니다.” 메시지 출력
  - 저장 중단

즉,

- UI에는 엑셀 버튼이 존재하지만
- 정책적으로 저장이 불가능한 상태

이로 인해 **정상적인 사용자 경로만으로는**  
다음 학기 강좌 전체 목록을 구조화된 파일로 확보할 수 없다.

👉 목표는 이 제한을 *우회*하는 것이 아니라,  
**브라우저가 이미 받아서 보여주고 있는 정보를  
합법적·비침투적으로 정리하는 것**이다.

---

## 1. 문제 정의

수강신청 검색 결과 페이지에서 다음 정보를  
**전 학과 / 전 페이지**에 대해 누적 수집한다.

- 강좌 목록  
  (과목명, 분반, 교수, 학과, 정원, 학점, 시간표 등)
- 교과목 개요  
  (국문 / 영문)

최종 결과는 **CSV(엑셀)** 파일로 저장한다.

단, 다음 행위는 하지 않는다.

- 서버 API 무차별 호출
- 로그인 세션 탈취
- 엑셀 차단 로직 변조
- 서버 내부 데이터 직접 접근

---

## 2. 기본 전략

> “엑셀 저장 버튼이 못 하게 막혀 있다면,  
> 브라우저가 이미 받고 있는 데이터를 내가 정리한다.”

접근 방식은 다음과 같다.

- Tampermonkey 또는 Chrome Extension 기반 **content script**
- DOM 접근 + **동일 출처 AJAX 요청만 사용**
- 사용자가 수동으로 할 수 있는 동작만 자동화

---

## 3. 강좌 목록 추출

강좌는 `.course-info-item` 단위로 렌더링된다.

각 강좌 카드에서 다음 정보를 확보한다.

- **hidden input 기반 정규 데이터**
  - 학년도, 학기, 교과목 코드, 분반 번호 등
- **화면 텍스트 기반 보조 정보**
  - 교수명, 학과, 코드 텍스트, 정원, 학점, 시간표

결과적으로 공식 엑셀 저장 기능보다  
**더 많은 필드**를 안정적으로 확보할 수 있었다.

---

## 4. 페이지네이션 문제

### 문제

- 페이지 UI는 다음과 같은 구조를 가진다.
<< < 1 2 3 4 5 > >>

- `<`, `>` 버튼은 +1 페이지 이동이 아니라 **페이지 그룹 이동**
- `fnGotoPage()`는 CSP 정책으로 content script에서 직접 호출 불가

### 해결

- `pageNo` hidden input을 가진 form(CC100 / HD102)을 탐색
- `pageNo = 현재 페이지 + 1`로 설정
- form submit으로 페이지 이동

이 방식으로 **항상 정확한 +1 페이지 이동**을 보장하였다.

---

## 5. 반자동 수집 구조 (resume 방식)

### 문제

- 페이지 이동 시 JS 컨텍스트 종료
- while-loop 기반 자동화는 1페이지 후 중단

### 해결

**resume 가능한 반자동 구조**를 설계하였다.

- 작업 상태를 `localStorage`에 저장
- 페이지 로드 시 step 함수가 **한 단계만 실행**
- 현재 페이지 누적
- (선택) 교과목 개요 수집
- 다음 페이지로 이동
- 새 페이지 로드 후 다시 resume

사용자는  
“다음 20페이지”, “끝까지” 같은 버튼만 누르면 된다.

---

## 6. 교과목 개요 수집 (엑셀에 없는 핵심 정보)

UI에서 강좌 상세 → 교과목개요를 직접 클릭하는 방식은 매우 느리다.

### 네트워크 분석

- `cc101ajax.action` → 개요 정보 없음
- `cc107ajax.action` → 국문 / 영문 교과목 개요 포함

### 해결

- `cc107ajax.action`을 동일 출처 `fetch`로 직접 호출
- **concurrency 기반 병렬 수집**

### 결과

- 페이지당 약 10개 개요를 **1초 미만**에 수집
- 공식 엑셀 저장으로는 얻을 수 없는 데이터 확보

---

## 7. 누락·중복 문제와 원인

### 현상

- 20페이지 × 10개 = 200개가 되어야 하지만
  - 201, 207, 211 등 불안정한 결과 발생
- 특정 페이지에서 9개만 누적
- 재실행 시 갑자기 항목이 추가됨

### 원인

- DOM은 생성되었으나 hidden input 값이 아직 채워지지 않은 상태
- 중복 제거 키가 `ltNo` 하나에 의존
- `ltNo`가 비어 있을 경우 키 충돌 발생

---

## 8. 키 설계 개선 (결정적 해결)

엑셀 저장 기능 내부와 유사한 수준의  
**복합 키 전략**을 도입하였다.

### 최종 키 구성

- year
- shtm
- deta
- sbjtCd
- (ltNo 또는 section)
- sbjtSubhCd

`section`은 화면의 코드 텍스트  
(예: `651.591(007)`)에서 보조 추출한다.

### 효과

- 렌더링 타이밍과 무관한 키 안정성 확보
- 재실행 시 누락 자동 보정
- 중복 없는 누적
- 페이지 순서 변경에도 안전

---

## 9. CSV 저장

공식 엑셀 저장이 막혀 있던 바로 그 목적을 달성하였다.

- BOM 포함 CSV 생성 (한글 깨짐 방지)
- 누적 개수 기반 파일명
- 강좌 목록 + 교과목 개요 포함

공식 엑셀 저장 버튼과 비교하면,

- 필드가 더 많고
- 제약이 없으며
- 개요 정보까지 포함된다.

---

## 10. 대규모 수집 과정에서의 추가 개선

### 10.1 revisit 구조 도입

- 누락 가능성이 있는 페이지를 큐로 관리
- main 수집 종료 후 해당 페이지만 재방문
- 최초 누락 자동 보완

### 10.2 resume 구조 정교화

- 페이지 중복 처리 및 무한 루프 방지
- 상태 값 분리로 안정성 강화

### 10.3 목표 개수 기반 종료 조건

- 목표 개수 도달 시 revisit 자동 종료
- 불필요한 반복 제거

### 10.4 개요 수집 로직 분리

- 페이지 단위 개요 수집
- 누적 전체 개요 복구(recovery) 모드 분리

### 10.5 localStorage 용량 문제 대응

- 중간 저장 최소화
- 대규모 개요 수집 시 CSV 직접 출력
- 저장 실패로 인한 전체 실패 구조 제거

---

## 11. 결론

이 도구는  
“엑셀 저장 차단을 뚫었다”기보다,

> **엑셀 저장 기능이 원래 담지 못하는 정보를  
> 사이트의 정상적인 동작 범위 안에서  
> 더 안정적이고 풍부하게 정리했다**

에 가깝다.

---

## 12. 얻은 교훈

- DOM 존재 ≠ 데이터 준비 완료
- 대규모 수집에서는  
  - 키 설계가 80%  
  - 네트워크 분석이 15%  
  - UI 자동화는 5%
- 한 번에 끝내는 자동화보다  
  **resume 가능한 반자동 구조가 훨씬 강건하다**
